name: Generate osu! skinhub-basic skins index

on:
  push:
    branches:
      - "**"
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  generate-skins-index:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare scripts
        run: |
          set -e
          chmod +x .github/workflows/detect-repo-meta.sh
          chmod +x .github/workflows/generate-skins-index.sh

      - name: Determine repository metadata
        id: meta
        run: |
          set -e
          # Load OWNER, REPO, BRANCH from helper script
          eval "$(.github/workflows/detect-repo-meta.sh)"

          echo "OWNER=$OWNER" >> "$GITHUB_OUTPUT"
          echo "REPO=$REPO" >> "$GITHUB_OUTPUT"
          echo "BRANCH=$BRANCH" >> "$GITHUB_OUTPUT"

      - name: Generate skins index content
        id: generate
        run: |
          set -e

          OWNER="${{ steps.meta.outputs.OWNER }}"
          REPO="${{ steps.meta.outputs.REPO }}"
          BRANCH="${{ steps.meta.outputs.BRANCH }}"

          .github/workflows/generate-skins-index.sh "$OWNER" "$REPO" "$BRANCH" "skins" "skins.md"

          echo "output_file=skins.md" >> "$GITHUB_OUTPUT"

      - name: Handle push/workflow_dispatch - commit and push if changed
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        run: |
          set -e

          OUTPUT_FILE="${{ steps.generate.outputs.output_file }}"

          if ! git diff --quiet -- "$OUTPUT_FILE"; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

            git add "$OUTPUT_FILE"
            git commit -m "chore: update skins index" || exit 0
            git push
          fi

      - name: Handle pull_request - validate only
        if: github.event_name == 'pull_request'
        run: |
          set -e

          OUTPUT_FILE="${{ steps.generate.outputs.output_file }}"

          # If there is any diff in skins.md compared to the regenerated version, fail
          if ! git diff --quiet -- "$OUTPUT_FILE"; then
            echo "skins.md is out of date. It is auto-generated by .github/workflows/generate-skins-index.yml and must match the generated content."
            exit 1
          fi